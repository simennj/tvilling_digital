<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div id="controls">
    <div>
        <form method="post" action="/datasources/create" name="subscribe">
            <label>
                Id:
                <input type="text" name="id" value="testrig">
            </label>
            <label>
                Address:
                <input type="text" name="address" value="129.241.90.108">
            </label>
            <label>
                Port:
                <input type="text" name="port" value="7331">
            </label>
            <br>
            Sensors:
            <label>
                Catman:
                <input type="checkbox" name="catman" checked>
            </label>
            <table>
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                </tr>
                </thead>
                <tbody id="sensors">
                </tbody>
                <tfoot>
                <tr>
                    <td colspan="2">
                        <button type="button" onclick="addSensor([])">Add Sensor</button>
                    </td>
                </tr>
                </tfoot>
            </table>
            <button type="submit">Create</button>
        </form>
    </div>
    <div>
        <form method="post" action="simulate" name="simulate">
            <label>
                Address:
                <input type="text" name="address" value="0.0.0.0">
            </label>
            <label>
                Port:
                <input type="text" name="port" value="7331">
            </label>
            <label>
                <select>

                </select>
            </label>
            <button>simulate</button>
        </form>
        <span id="simulation"></span>
    </div>
</div>
<hr>
<div id="chartContainer" style="width: 100%"></div>
<ul id="l"></ul>
<span id="i">0</span>
<script src="https://cdn.plot.ly/plotly-latest.js" charset="utf-8"></script>
<script>

    fetch('http://localhost:1337/fmus/testrig.fmu/vars').then(response =>
        console.log(response.json().then(console.log))
    );

    const sensors = document.getElementById('sensors');

    // Store reference to container for plot
    var graphContainer = document.getElementById('chartContainer');

    // Container for displacement plot data
    var displacements = {x: [[]], y: [[]]};

    // Initialise plot
    Plotly.newPlot(
        graphContainer,
        [{y: [], x: []}],
        {
            title: 'Displacement',
            yaxis: {
                title: 'Displacement (m)'
            },
            xaxis: {
                title: 'Timestamp'
            }
        },
        {responsive: true}
    );

    function addSensor(name = '') {
        sensors.insertAdjacentHTML('beforeend',
            '<tr>' +
            '<td><label><input type="text" name="output_name" value="' + name + '"></label></td>' +
            '</tr>'
        );
    }

    [
        'Time 1 - default sample rate',
        'Time 1 - slow sample rate',
        'Time 1 - fast sample rate',
        'Load [N]',
        'Displacement [mm]',
        'AccelerometerX',
        '0 Degrees Transvers on Axle',
        'Rosett +45 Degrees Along Axle',
        'Rosett 90 Degrees Along Axle',
        'Rosett -45 Degrees Along Axle',
        'Radius +45 Degrees Along Axle',
        'MX840A 0 hardware time default sample rate',
    ].forEach(addSensor);

    document.forms.namedItem('subscribe').addEventListener('submit', ajaxSubmit);
    document.forms.namedItem('simulate').addEventListener('submit', ajaxSubmit);

    function ajaxSubmit(event) {
        const formData = new FormData(event.target);
        const request = new XMLHttpRequest();
        request.open("POST", event.target.action, true);
        request.onload = function () {
            event.target.insertAdjacentHTML('afterend', request.responseText);
        };
        request.send(formData);
        event.preventDefault();
    }

    const l = document.getElementById('l');

    const i = document.getElementById('i');

    let pingInterval = null;

    reconnect();

    // const buffer_size = 1000;
    // let buffer_position = 0;
    // let x_buffer = new Float64Array(buffer_size), y_buffer = new Float64Array(buffer_size);
    // x_buffer.fill(0)
    // y_buffer.fill(0)
    function reconnect() {
        try {
            const ws = new WebSocket('ws://' + window.location.hostname + ':' + window.location.port);
            ws.binaryType = 'arraybuffer';

            let messageRecentlyReceived = true;
            ws.onopen = function () {
                l.insertAdjacentHTML('afterbegin', '<br><strong>Connected</strong><br>');
                if (pingInterval == null) {
                    pingInterval = setInterval(function () {
                        if (messageRecentlyReceived) {
                            messageRecentlyReceived = false;
                        } else {
                            ws.send('__ping__');
                        }
                    }, 5000)
                }
            };
            ws.onclose = function () {
                reconnect()
            };
            // let counter = 0;
            ws.onmessage = function (event) {
                messageRecentlyReceived = true;
                if (event.data.byteLength > 0) {
                    const data = new Float64Array(event.data);

                    // let x_buffer = []
                    // let y_buffer = []

                    for (let i = 0; i < data.length / 13; i += 13) {
                        // x_buffer.push(data[i + 12]);
                        // y_buffer.push(data[i + 5]);
                        // buffer_position = ++buffer_position % buffer_size
                        // displacements.x[0].push(new Date(
                        //     (x_buffer.reduce((a, b) => a + b) / x_buffer.length) * 1000
                        // ));
                        // displacements.y[0].push(
                        //     (y_buffer.reduce((a, b) => a + b) / y_buffer.length)
                        // );
                        // buffer_position = 0;
                        Plotly.extendTraces(graphContainer, {y: [[data[i + 5]]], x: [[new Date(data[i + 12]*1000)]]}, [0], 1000);
                    }
                    // Plotly.extendTraces(graphContainer, {y: [y_buffer], x: [x_buffer]}, [0], 10000);
                    // displacements.x[0] = x_buffer;
                    // displacements.y[0] = y_buffer;
                    // let newli = document.createElement('li');
                    // newli.innerText = data.toString(); //new Float32Array(event.data);
                    // l.insertAdjacentElement('afterbegin', newli);
                    i.innerHTML = '<strong>' + ++counter + ":</strong><br>" + data;
                } else {
                    console.log('pong')
                }
            };
        } catch (e) {
            console.log(e);
            setTimeout(reconnect, 5000)
        }
    }

    // window.requestAnimationFrame(asdf);
    // function asdf() {
    //     displacements.x[0] = Array.from(x_buffer);
    //     displacements.y[0] = Array.from(y_buffer);
    //     Plotly.restyle(graphContainer, displacements);
    // window.requestAnimationFrame(asdf)
    // }
</script>
<style>
    #controls {
        display: flex;
        justify-content: space-evenly;
    }

    input[name='name'] {
        width: 20rem;
    }

    input[name='type'] {
        width: 1rem;
        text-align: center;
    }
</style>
</body>
</html>
